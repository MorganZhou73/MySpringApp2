# Demo for Spring RESTfull Web Service accessing MongoDB/SQL Server/RabbitMQ
	docker-compose to initiate MongoDB/SqlServer
	
## Guides
	
	\Docker
		Demo docker-compose to initiate MongoDB/SqlServer in Docker
		
	\myservice2: Spring RESTfull Web Service accessing MongoDB
		to demo Spring MVC, WebSecurityConfigurerAdapter
		receive message from RabbitMQ, and save to MongoDB
	
	\myservice3: Spring Web Service accessing SQL Server DB
		send message to RabbitMQ
	
	\SimpleAngularJS:
		simple web to test AngularJS
		to start server:
			spring run app.groovy -- --server.port=8080
		
	\SimpleJQuery:
		simple web to test jQuery 
		to start server:
			spring run app.groovy -- --server.port=9101

	\SimpleNodeJS:
		simple web to test NodeJS 
		to start server:
			node myfirst.js
			; then you can access http://localhost:8080/  -- the port is specified in the .js
		
	\angularapp1: 
		Spring Boot with Angular 

	\myreactapp2: React JS project. generated by 
		npx create-react-app myreactapp2

-------------------------------------------------------------------------
## How to Run on Docker
  - Approch 1: 
  	use docker-compose to build myservice2/myservice3 from Docker automaticaly, this needs to pull maven.
  
	docker-compose -f docker-compose-v1.yml up -d

  - Approch 2: 
	build myservice2/myservice3 locally at first, so no need to pull maven:
	
	1. compile myservice2 to generate target/*.jar from Command window
		cd ./myservice2
		mvn clean package -Dmaven.test.skip=true
			-- or 
		mvn clean package -DskipTests
		cd ..
	
	2. compile myservice3 to generate target/*.jar from Command window
		cd ./myservice3
		mvn clean package -Dmaven.test.skip=true
		cd ..

	3. load the compose to container and run (from either Command window or PowerShell )
		docker-compose -f docker-compose.yml up -d

	then, we can test 
		myservice2 : http://localhost:8081/
		myservice3 : http://localhost:8080/
	
	; delete all the relative containers, but the docker images remains
	docker-compose -f docker-compose.yml down
	
-------------------------------------------------------------------------
## Clean the relative containers and images in docker

docker stop myservice2
docker rm myservice2

docker stop myservice3
docker rm myservice3

docker stop mongodb_container
docker rm mongodb_container

docker stop rabbitmq
docker rm rabbitmq

docker stop sql-server-db
docker rm sql-server-db

docker image rm myservice2:tag-1.0.0
docker image rm myservice3:tag-1.0.0
docker image rm sql-testdb:tag-1.0.0

-------------------------------------------------------------------------
## Compile commands

; compile and run unit test
mvn clean package

; compile unit test, but not run unit test
mvn clean package -DskipTests

; To skip compiling the tests
mvn clean package -Dmaven.test.skip=true

; Run all the unit test classes.
mvn test

; Run a single test class.
mvn -Dtest=TestApp1 test

; Run multiple test classes.
mvn -Dtest=TestApp1,TestApp2 test

; Run a single test method from a test class.
mvn -Dtest=TestApp1#methodname test

-------------------------------------------------------------------------
## Test RabbitMQ on Docker Seperately
	docker pull rabbitmq:3-management-alpine
	docker run --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management-alpine
	
	docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management-alpine

-------------------------------------------------------------------------
## Test MongoDB on Docker Seperately

	cd ./docker

	docker pull mongo:latest
	
	; launch the image as container
	docker-compose -f docker-compose-mongo.yml up -d
	docker ps -a
	
	; Login to the container by using container names from PowerShell
	docker exec -it mongodb_container bash
	
	; login to the container from Git Bash
	winpty docker exec -it mongodb_container bash
	
	; then could login to mongoDB: the db user name should be different with the root user name for Docker test
	mongo -u "root" -p "V4321abcd!" --authenticationDatabase "admin"
	mongo -u "user1" -p "V4321abcd!" --authenticationDatabase "Northwind"
	
	use admin
	show users;
	show dbs;

	use Northwind
	show users;
	; should get like { "_id" : "Northwind.user1", ...} ; otherwise, may fail for the mongo Docker test
	
	show collections 
	db.person.find()
	db.person.save({"firstName":"Joe", "lastName":"Zhou"})	

	; to remove the container from docker
	docker stop mongodb_container
	docker rm mongodb_container
	
	docker-compose -f docker-compose-mongo.yml down

	docker logs mongodb_container | grep error
	db = db.getSiblingDB("Northwind");
	
	; view javascript file in mongo container
	cat /docker-entrypoint-initdb.d/init-mongo.js
	
	;Execute a JavaScript file:
	load("/docker-entrypoint-initdb.d/init-mongo.js")
	
	; we can also use Robo 3T to verify the DB
-------------------------------------------------------------------------
## Both postgres and mysql images already support using environment variable 
   to create an initial database when the image is run and the container is 
   created (POSTGRES_DB: "mydb" or MYSQL_DATABASE: "mydb")
   
   For MS SqlServer, cannot initialize DB from docker-compose directly

-------------------------------------------------------------------------
## Test SqlServer on Docker Seperately

	cd ./docker
	docker build -t sql-testdb:tag-1.0.0 -f Dockerfile-mssql .
	
	; launch the image as container
	docker run -e 'ACCEPT_EULA=Y' -e 'SA_PASSWORD=V4321abcd!' -e 'MSSQL_DB=TestDB' -e 'MSSQL_USER=user1' -e 'MSSQL_PASSWORD=V4321abcd!' -p 1433:1433 --name sql-server-db -d sql-testdb:tag-1.0.0
	
	; or run from docker-compose
	docker-compose -f docker-compose-mssql.yml up -d

	; Login to the container by using container names from PowerShell
	docker exec -it sql-server-db bash
	
	; login to the container from Git Bash
	winpty docker exec -it sql-server-db bash
	
	/opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'V4321abcd!'
	/opt/mssql-tools/bin/sqlcmd -S localhost -U user1 -P 'V4321abcd!'
		1> SELECT @@VERSION
		2> GO
		
		1> select name from sys.databases;
		2> go

	; access from outside of the Docker, e.g. Command window	
	OSQL -S localhost -U sa -P "V4321abcd!" -Q "USE [master]; SELECT @@Version"
	OSQL -S localhost,1433 -U sa -P "V4321abcd!" -Q "USE [master]; SELECT @@Version"
	
	; to remove the container and image	from docker
	docker stop sql-server-db
	docker rm sql-server-db
	docker image rm sql-testdb:tag-1.0.0
	
	docker ps -a
	docker image ls
	
	; we can also use Azure Data Studio to verify the DB

-------------------------------------------------------------------------
## Make images for myservice2 / myservice3

	1. make image for myservice2:tag-1.0.0
		cd ./myservice2
		mvn clean package
		docker build -t myservice3:tag-1.0.0 .
	
	2. make image for myservice3:tag-1.0.0
		cd ./myservice3
		mvn clean package
		docker build -t myservice3:tag-1.0.0 .

-------------------------------------------------------------------------
   	  